{% extends 'extends/main_interface.html' %}

{% block aside_var %}
    {% with production_active=True %}
        {{ block.super }}
    {% endwith %}
{% endblock aside_var %}

{% block main_var %}
    {% with header=True %}
        {{ block.super }}
    {% endwith %}
{% endblock main_var %}

{% block title %}Production Management{% endblock %}

{% block header %}
<div class="flex w-full bg-[#335b39] pl-6 pr-4 gap-8">
    <!-- Search Bar -->
    <div class="flex items-center justify-center gap-4 flex-1">
        <input type="text" id="production-search" class="w-[60%] pl-8 pr-2 py-2 border rounded-full focus:ring-green-600 focus:border-green-600" placeholder="Search production jobs...">
        <button id="search-btn" class="bg-green-700 text-white px-4 py-2 rounded-lg">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <div class="flex basis-[20%] justify-end">
        <!-- Inventory Management Button -->
        <button id="inventory-management-btn" class="bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <i class="fas fa-cogs"></i> <span class="flex-1">Inventory</span>
        </button>

        <!-- Notification Button -->
        <button id="notification-btn" class="px-4 py-2 rounded-lg flex items-center gap-2 ml-4 bg-yellow-400">
            <i class="fas fa-bell text-black font-bold text-2xl"></i>
        </button>
    </div>
</div>

<!-- Popover for Inventory Management -->
<div id="inventory-popover-container" class="hidden absolute top-full left-0 m-2 bg-white border border-green-600 rounded-lg shadow-lg w-[calc(100%-16px)] max-h-[500px] overflow-auto scrollbar-thin scrollbar-thumb-green-700 scrollbar-track-green-200">
</div>

<!-- Popover for Notifications -->
<div id="notification-popover-container" class="hidden absolute top-16 right-10 bg-white border border-green-600 rounded-lg shadow-lg w-[40%] max-h-[400px] overflow-auto z-50 scrollbar-thin scrollbar-thumb-green-700 scrollbar-track-green-200">
</div>


<script>
    $(document).ready(function() {
        $('#search-btn').on('click', function() {
            const query = $('#production-search').val();
            $.ajax({
                url: '/production/search/',
                method: 'GET',
                data: { query },
                success: function(response) {
                    $('.tab-content-container').html(response);
                },
                error: function() {
                    alert('Error fetching search results.');
                }
            });
        });
    
        $('#inventory-management-btn').on('click', function() {
            const popover = $('#inventory-popover-container');
            popover.toggleClass('hidden');
            if (!popover.hasClass('hidden')) {
                $.ajax({
                    url: '/inventory/management/',
                    type: "GET",
                    beforeSend: function () {
                        $("#inventory-popover-container").html('<p class="text-center text-green-500">Loading...</p>');
                    },
                    success: function (data) {
                        $("#inventory-popover-container").html(data);
                    },
                    error: function () {
                        $("#inventory-popover-container").html('<p class="text-center text-red-500">Failed to load inventory data.</p>');
                    }
                });
            }
        });
    
        $('#notification-btn').on('click', function() {
            const popover = $('#notification-popover-container');
            popover.toggleClass('hidden');
            if (!popover.hasClass('hidden')) {
                $.ajax({
                    url: '/inventory/alerts/',
                    method: 'GET',
                    success: function(response) {
                        popover.html(response);
                    },
                    error: function() {
                        popover.html('<p class="text-red-500">Error loading notifications!</p>');
                    }
                });
            }
        });
    });
</script>
    
{% endblock %}

{% block content %}
<div class="production-container flex flex-col h-full bg-gray-50">
    <!-- Tabs for Production -->
    <div class="production-tab-container flex justify-center gap-4 py-0 px-4 border-b mx-5 border-green-600">
        <button class="production-tab" data-tab="job-scheduling">
            <span><i class="fas fa-calendar-alt text-green-700"></i> Job Scheduling</span>
        </button>
        <button class="production-tab" data-tab="production-tracking">
            <span><i class="fas fa-chart-line text-green-700"></i> Production Tracking</span>
        </button>
        <button class="production-tab" data-tab="quality-control">
            <span><i class="fas fa-check-circle text-green-700"></i> Quality Control</span>
        </button>
    </div>

    <!-- Tab Contents -->
    <div class="tab-content-container h-full flex gap-[5px] px-[10px] pt-1 pb-[16px] overflow-hidden">
        <!-- Job Scheduling Content (Initially active) -->
        <div id="job-scheduling" class="tab-content overflow-y-hidden flex-1 basis-[60%]">
            <div class="included-template overflow-y-hidden">
                {% include 'includes/production/production_jobscheduling.html' %}
            </div>
        </div>

        <!-- Production Tracking Content -->
        <div id="production-tracking" class="tab-content flex-1 basis-[40%]">
            <div class="included-template overflow-y-hidden">
                {% include 'includes/production/production_tracking.html' %}
            </div>
        </div>

        <!-- Quality Control Content -->
        <div id="quality-control" class="tab-content flex-1 basis-[35%]">
            <div class="included-template overflow-y-hidden">
                {% include 'includes/production/production_qualitycontrol.html' %}
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        const tabs = $('.production-tab');
        const contents = $('.tab-content');
        let activeTabs = ['job-scheduling'];

        let singleClickTimer;
        const delay = 300;
        $('#job-scheduling').addClass('active');
        $('.production-tab[data-tab="job-scheduling"]').addClass('active');
    
        tabs.on('click', function(){
            const clickedTab = $(this);
            
            console.log("Current active tabs: " + activeTabs);
            if (singleClickTimer) {
                clearTimeout(singleClickTimer);
                singleClickTimer = null;
                handleDoubleClick(event, clickedTab);
            } else {
                singleClickTimer = setTimeout(() => {
                    handleSingleClick(event, clickedTab);
                    singleClickTimer = null;
                }, delay);
            }
        });

        function handleSingleClick(event, clickedTab) {
            const tabId = clickedTab.data('tab');
            const content = $('#' + tabId);
            console.log("Tab clicked: " + tabId);
            console.log('Single click detected');
            console.log("Single active tab, replacing content with: " + tabId);
        
            activeTabs.forEach((tabId) => {
                if (tabId !== clickedTab.data('tab')) {
                    const currentActiveTab = $('.production-tab[data-tab="' + tabId + '"]');
                    const currentActiveContent = $('#' + tabId);
        
                    currentActiveTab.removeClass('active');
                    currentActiveContent.removeClass('active');
                }
            });
        
            clickedTab.addClass('active');
            content.addClass('active');
        
            activeTabs = [tabId]; 
            console.log(activeTabs);

            if(activeTabs.includes("job-scheduling")){
                $('.form-fields').removeClass("flex-col");
            }
        }
        

        function handleDoubleClick(event, clickedTab) {
            console.log('Double click detected');
            const tabId = clickedTab.data('tab');
            const content = $('#' + tabId);
            if (activeTabs.length === 2) {
                if(!(activeTabs.includes(tabId))){
                    const firstActiveTabId = activeTabs[0];
                    const firstActiveTab = $('.production-tab[data-tab="' + firstActiveTabId + '"]');
                    const firstActiveContent = $('#' + firstActiveTabId);
            
                    firstActiveTab.removeClass('active');
                    firstActiveContent.removeClass('active');
            
                    activeTabs.shift()
                    console.log(activeTabs);
                    clickedTab.addClass('active');
                    content.addClass('active');
            
                }
            } else if (activeTabs.length === 1) {
                
                console.log("Two active tabs, adding new tab: " + tabId);
        
                if (!activeTabs.includes(tabId)) {
                    clickedTab.addClass('active');
                    content.addClass('active');
        
                    activeTabs.push(tabId);
                    console.log(activeTabs);
                }
            }
            if(activeTabs.includes("job-scheduling")){
                if($('#order-sidebar').css('flex-basis') !== '0px'){
                    $('#toggle-sidebar').click();
                }
                $('.form-fields').addClass("flex-col");
            }
        }
        
    });
    
</script>
<!-- CSS for handling active states, transitions, and tab display -->
<style>
    .production-tab {
        padding: 10px;
        font-size: 18px;
        border: 2px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .production-tab.active {
        font-weight: 600;
        border-bottom: 4px solid #28a745;
    }

    .tab-content {
        border-bottom: 4px solid #28a745;
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    .tab-content.active {
        display: block;
        opacity: 1;
    }
    .included-template {
        display: block;
        height: 100%;
    }
</style>
{% endblock %}

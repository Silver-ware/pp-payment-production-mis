{% extends 'extends/main_interface.html' %}
{% load static %}

{% block aside_var %}
    {% with dashboard_active=True %}
        {{ block.super }}
    {% endwith %}
{% endblock aside_var %}

{% block title %}Dashboard{% endblock %}

{% block content %}
  <div class="h-full pb-3 px-4 bg-gray-50 overflow-auto scrollbar-thin scrollbar-thumb-green-500 scrollbar-track-gray-300">
    <div class="sticky top-0 bg-gray-50 px-6 flex justify-between w-full pb-2 pt-3 mb-3 border-b-2 border-dashed border-green-700">
      <h1 class="text-2xl font-semibold"><i class="fas fas fa-tachometer-alt text-green-700"></i> System Overview</h1>
    </div>
    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <!-- Orders and Statuses -->
      <div class="p-4 bg-white shadow-md rounded-lg hover:shadow-xl shadow-green-600 hover:shadow-green-900 transition duration-300 ease-in-out">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center border-b border-green-700 mb-1">
          <i class="fas fa-boxes mr-2 text-green-700"></i> Recent Orders {{ revenue_labels|json_script }}
        </h3>
        <ul class="space-y-2">
          {% for order in recent_orders %}
          <li class="flex justify-between border-b pb-2">
            <span><i class="fas fa-box text-blue-500 mr-1"></i> Order #{{ order.order_id }}</span>
            <span class="bg-yellow-300 px-2 py-1 rounded text-sm">{{ order.status }}</span>
          </li>
          {% empty %}
          <li class="text-gray-500">No recent orders available.</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Payment Summaries -->
      <div class="p-4 bg-white shadow-md rounded-lg hover:shadow-xl shadow-green-600 hover:shadow-green-900 transition duration-300 ease-in-out">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center border-b border-green-700 mb-1">
          <i class="fas fa-credit-card mr-2 text-green-700"></i> Payment Summary
        </h3>
        <div class="space-y-2">
          <div><i class="fas fa-dollar-sign text-green-500"></i> Total Revenue: <span class="font-bold">₱{{ total_revenue }}</span></div>
          <div><i class="fas fa-exclamation-circle text-red-500"></i> Overdue Payments: <span class="font-bold text-red-500">₱{{ overdue_payments }}</span></div>
        </div>
      </div>

      <!-- Inventory Alerts -->
      <div class="p-4 bg-white shadow-md rounded-lg hover:shadow-xl shadow-green-600 hover:shadow-green-900 transition duration-300 ease-in-out">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center border-b border-green-700 mb-1">
          <i class="fas fa-box-open mr-2 text-green-700"></i> Inventory Alerts
        </h3>
        <ul class="space-y-2">
          {% for item in low_stock_items %}
          <li class="text-sm"><i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i> <span class="uppercase font-semibold">{{ item.name }}</span>: Low Stock ({{ item.stock_level }} remaining)</li>
          {% empty %}
          <li class="text-gray-500">No low stock alerts.</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Charts and Graphs -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">
      <!-- Line Chart for Revenue -->
      <div class="p-4 bg-white shadow-md rounded-lg hover:shadow-xl shadow-green-600 hover:shadow-green-900 transition duration-300 ease-in-out">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center border-b border-green-700 mb-1">
          <i class="fas fa-chart-line mr-2 text-green-700"></i> Revenue Over Time
        </h3>
        <canvas id="revenueChart"></canvas>
      </div>

      <!-- Pie Chart for Order Status -->
      <div class="p-4 bg-white shadow-md rounded-lg hover:shadow-xl transition shadow-green-600 hover:shadow-green-900 duration-300 ease-in-out">
        <h3 class="text-lg font-semibold text-gray-800 flex items-center border-b border-green-700 mb-1">
          <i class="fas fa-chart-pie mr-2 text-green-700"></i> Order Status Breakdown
        </h3>
        <canvas id="orderStatusChart"></canvas>
      </div>
    </div>

    <!-- Notifications / Pending Actions -->
    <div class="mt-6 pb-4 relative bg-white shadow-md rounded-lg hover:shadow-xl shadow-green-600 hover:shadow-green-900 transition duration-300 ease-in-out max-h-[300px] overflow-auto scrollbar-thin scrollbar-thumb-green-500 scrollbar-track-gray-300">
      <h3 class="px-1 py-2 sticky top-0 bg-white text-lg font-semibold text-gray-800 flex items-center border-b border-green-700 mb-1 mx-2">
        <i class="fas fa-tasks mr-2 text-green-700"></i> <span class="text-red-700 font-bold mr-2">HIGH </span><span> PRIORITY PRODUCTION JOBS </span>
      </h3>
      <ul class="px-4">
        {% for task in pending_tasks %}
        <li class="flex justify-between py-2">
          <span>
            <i class="fa fa-industry text-yellow-700 mr-1"></i>
            <span class="font-semibold ">Service: {{ task.order__service__name }}
            <span class="font-bold text-blue-800"> | </span> </span> Customer Name: {{ task.order__customer__name }}</span>
          <span class="text-sm font-bold">{{ task.status }}</span>
        </li>
        {% empty %}
        <li class="text-gray-500">No pending tasks.</li>
        {% endfor %}
      </ul>
    </div>
  </div>

  {{ revenue_labels|json_script:"revenueLabels" }}
  {{ revenue_data|json_script:"revenueData" }}
  {{ order_status_data|json_script:"orderStatusData" }}
  {{ order_status_labels|json_script:"orderStatusLabels" }}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Safely retrieve the JSON data
        const revenueLabels = JSON.parse(document.getElementById('revenueLabels').textContent);
        const revenueData = JSON.parse(document.getElementById('revenueData').textContent);
        const orderStatusData = JSON.parse(document.getElementById('orderStatusData').textContent);
        const orderStatusLabels = JSON.parse(document.getElementById('orderStatusLabels').textContent);

        // Debugging the data being passed to the charts
        console.log("Revenue Labels:", revenueLabels);
        console.log("Revenue Data:", revenueData);
        console.log("Order Status Data:", orderStatusData);
        console.log("Order Status Labels:", orderStatusLabels);

        // Initialize Revenue Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        const revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Revenue (₱)',
                    data: revenueData,
                    borderColor: 'rgb(75, 192, 192)',
                    fill: false,
                }]
            },
        });

        // Initialize Order Status Chart
        const orderStatusCtx = document.getElementById('orderStatusChart').getContext('2d');
        const orderStatusChart = new Chart(orderStatusCtx, {
            type: 'pie',
            data: {
                labels: orderStatusLabels,
                datasets: [{
                    data: orderStatusData,
                    backgroundColor: ['#ffcc00', '#4caf50', '#ff5722', '#f44336'],
                }]
            },
        });
    });
</script>
<style>
  canvas{
    width: 10px;
  }
</style>
{% endblock %}
